# 模型权值定点化计算

- 输入

```python
import numpy as np
layer_input = np.array([-8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105,
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105, 
                        -8, 12, 16, 15, 27, 38, 44, 44, 53, 48, 60, 64, 69, 71, 78, 79, 75, 80, 86, 87, 93, 95, 97, 105]).astype(np.int32)


layer_input_float = np.array([-1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396, 
                              -1.779649, 3.175560, 4.038485, 3.944014, 6.891172, 9.536197, 11.016277, 11.041678, 13.336216, 12.168105, 15.152960, 16.259809, 17.415588, 17.789117, 19.675145, 20.006628, 18.999565, 20.053386, 21.578744, 21.806348, 23.476032, 23.818897, 24.319860, 26.283396])

before_state = np.array([22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14,
                         22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14,
                         22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14,
                         22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14,
                         22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14,
                         22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14])

before_state_float = np.array([94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695,
                               94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695,
                               94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695,
                               94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695,
                               94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695,
                               94.76114139924849, 197.78109105812297, 35.416106654280696, 64.16662034110297, 0.0, 60.86104215555047, 13.403101685676361, 468.8080916877411, 7.09418210303442, 120.84395171316518, 77.71148406725023, 80.23446868764282, 134.23943384404882, 56.09165222271493, 0.0, 6.806075452558279, 30.13324865012278, 83.12259601623082, 10.976933648700353, 65.86630599650354, 236.99826810804643, 68.7580989241692, 118.09761143690373, 28.047988303187193, 42.321191745339206, 25.70925861122943, 32.008103698594745, 60.019242762707194, 152.17173297801907, 17.119576232613635, 0.7089928898785018, 94.98773781620085, 54.94997515758671, 11.671752457654364, 71.61609175436539, 99.48914187989993, 96.2431052291002, 79.50912872303198, 27.358792949905194, 99.34185271197288, 63.45805155094455, 10.401956110272888, 250.27841830953355, 77.30748550130903, 106.4468188467651, 0.0, 8.647474419825434, 43.46936667821245, 71.15066145022641, 67.42478370811976, 64.58696084357697, 113.51198776150693, 90.57553981638503, 124.21254787280895, 42.53384337972501, 32.20942699441127, 37.19472554123688, 34.69366276680971, 83.593227092352, 78.81536907409262, 75.24618651656863, 51.93696937453028, 36.34908716548816, 55.96186741860695])
```

**- 定点输入为8位Q5.2数据,浮点输入与定点输入相对应;权值是Q7**

- 第一层计算

```python
# 浮点计算
weight_1_float = np.load("save/cfsmn_dense1_kernel_0_float.npy")
bias_1_float = np.load("save/cfsmn_dense1_bias_0_float.npy")
layer_out_1_float = np.clip(np.matmul(weight_1_float, layer_input_float) + bias_1_float, a_min=0.0, a_max=2.0**32)
# 量化
layer_out_1_q = (layer_out_1_float * 2**9).astype(np.int32)
# 定点计算: Q7 * Q2 + Q7<<2
weight_1 = np.load("save/cfsmn_dense1_kernel_0.npy").astype(np.int32)
bias_1 = np.load("save/cfsmn_dense1_bias_0.npy").astype(np.int32)
layer_out_1 = np.clip(np.matmul(weight_1, layer_input) + bias_1<<2, a_min=0, a_max=2**32)

#8位缩放: Q9 >> 9 = Q0
n_shift = int(np.log2(max(abs(layer_out_1.min()), abs(layer_out_1.max()))))
shift_32 = 31 - n_shift - 1
shift_8 = 31 - 7 - shift_32

print("nshift: {}, shift_32:{}, shift_8:{}".format(n_shift, shift_32, shift_8))

layer_out_1_8 = layer_out_1>>shift_8
```

```
layer_out_1_q = [1096, 32503, 0, 13175, 8181, 21287, 42768, 0, 11308, 0, 0, 0, 47357, 0, 26079, 0, 10279, 0, 0, 47707, 0, 31394, 0, 0, 55138, 0, 18662, 0, 21151, 46507, 589, 16303, 16194, 9449, 0, 0, 1991, 25557, 0, 15244, 5501, 6514, 3690, 58265, 38953, 5411, 7004, 22690, 0, 0, 8436, 0, 17384, 0, 0, 1920, 11223, 0, 0, 0, 34684, 25002, 0, 5352]

layer_out_1   = [ 873, 32322, 0, 12803, 8337, 20928, 42690, 0, 11665, 0, 0, 0, 46606, 0, 26302, 0,  9807, 0, 0, 47149, 0, 31679, 0, 0, 54870, 0, 18546, 0, 21410, 45977, 863, 15667, 16132, 9012, 0, 0, 2484, 25485, 0, 15685, 5506, 6165, 2865, 57727, 38316, 4980, 7010, 22268, 0, 0, 8313, 0, 17543, 0, 0, 2057, 11238, 0, 0, 0, 33990, 25119, 0, 5710]

# nshift: 15, shift_32:15, shift_8:9
layer_out_1_8 = [1, 63, 0, 25, 16, 40, 83, 0, 22, 0, 0, 0, 91, 0, 51, 0, 19, 0, 0, 92, 0, 61, 0, 0, 107, 0, 36, 0, 41, 89, 1, 30, 31, 17, 0, 0, 4, 49, 0, 30, 10, 12, 5, 112, 74, 9, 13, 43, 0, 0, 16, 0, 34, 0, 0, 4, 21, 0, 0, 0, 66, 49, 0, 11]
```


- 第二层计算

```python
# 浮点计算
weight_2_float = np.load("save/cfsmn_dense2_kernel_0_float.npy")
bias_2_float = np.load("save/cfsmn_dense2_bias_0_float.npy")
layer_out_2_float = np.clip(np.matmul(weight_2_float, layer_out_1_float) + bias_2_float,a_min=0.0, a_max=2.0**32)
# 量化
layer_out_2_q = (layer_out_2_float * 2**7).astype(np.int32)
# 定点计算: Q7 * Q0 + Q7
weight_2 = np.load("save/cfsmn_dense2_kernel_0.npy").astype(np.int32)
bias_2 = np.load("save/cfsmn_dense2_bias_0.npy").astype(np.int32)
layer_out_2 = np.clip(np.matmul(weight_2, layer_out_1_8) + bias_2, a_min=0, a_max=2**32)

#8位缩放: Q7 >> 7 = Q0
n_shift = int(np.log2(max(abs(layer_out_2.min()), abs(layer_out_2.max()))))
shift_32 = 31 - n_shift - 1
shift_8 = 31 - 7 - shift_32

print("nshift: {}, shift_32:{}, shift_8:{}".format(n_shift, shift_32, shift_8))

layer_out_2_8 = layer_out_2>>shift_8
```

```
layer_out_2_q = [6967, 0, 1711, 2703, 4234, 15243, 0, 4109, 5903, 0, 9446, 119, 10561, 4899, 6938,  991, 9091, 0, 1439, 0, 0, 7082, 8237, 11965, 0, 3817, 7711, 8709, 9136, 6769, 6196, 4736, 0, 2940, 13475, 0, 0, 5377, 5018, 7018, 0, 0, 0, 2234, 5201, 14620, 8839, 6724, 0, 2831, 485, 10059, 2230, 8424, 10259, 5143, 0, 0, 362, 1692, 8278, 2111, 0, 6957]

layer_out_2   = [6857, 0, 1705, 2598, 3967, 15253, 0, 4309, 5754, 0, 9142, 104, 10238, 4830, 6688, 1053, 8670, 0, 1414, 0, 0, 7076, 7841, 11659, 0, 3808, 7616, 8604, 8995, 6676, 6292, 4487, 0, 3023, 13309, 0, 0, 5236, 4874, 7126, 0, 0, 0, 2296, 5090, 14427, 8624, 6567, 0, 2916, 356,  9930, 1962, 8316, 10190, 4922, 0, 0, 127, 1711, 8384, 1884, 0, 7013]

# nshift: 13, shift_32:17, shift_8:7
layer_out_2_8 = [53, 0, 13, 20, 30, 119, 0, 33, 44, 0, 71, 0, 79, 37, 52, 8, 67, 0, 11, 0, 0, 55, 61, 91, 0, 29, 59, 67, 70, 52, 49, 35, 0, 23, 103, 0, 0, 40, 38, 55, 0, 0, 0, 17, 39, 112, 67, 51, 0, 22, 2, 77, 15, 64, 79, 38, 0, 0, 0, 13, 65, 14, 0, 54]
```

- 第三层计算

```python
# 浮点计算
weight_3_float = np.load("save/cfsmn_dense3_kernel_0_float.npy")
bias_3_float = np.load("save/cfsmn_dense3_bias_0_float.npy")
layer_out_3_float = np.clip(np.matmul(weight_3_float, layer_out_2_float) + bias_3_float, a_min=0.0, a_max=2.0**32)
# 量化
layer_out_3_q = (layer_out_3_float * 2**7).astype(np.int32)
# 定点计算:Q7 * Q0 + Q7
weight_3 = np.load("save/cfsmn_dense3_kernel_0.npy").astype(np.int32)
bias_3 = np.load("save/cfsmn_dense3_bias_0.npy").astype(np.int32)
layer_out_3 = np.clip(np.matmul(weight_3, layer_out_2_8) + bias_3, a_min=0, a_max=2**32)

#8位缩放: Q7 >> 9 = Q-2
n_shift = int(np.log2(max(abs(layer_out_3.min()), abs(layer_out_3.max()))))
shift_32 = 31 - n_shift - 1
shift_8 = 31 - 7 - shift_32

print("nshift: {}, shift_32:{}, shift_8:{}".format(n_shift, shift_32, shift_8))

layer_out_3_8 = layer_out_3 >> shift_8
```

```
layer_out_3_q = [12129, 25315, 4533, 8213, 0, 7790, 1715, 60007, 908, 15468,  9947, 10270, 17182, 7179, 0, 871, 3857, 10639, 1405, 8430, 30335, 8801, 15116, 3590, 5417, 3290, 4097, 7682, 19477, 2191, 90, 12158, 7033, 1493, 9166, 12734, 12319, 10177, 3501, 12715, 8122, 1331, 32035, 9895, 13625, 0, 1106, 5564, 9107, 8630, 8267, 14529, 11593, 15899, 5444, 4122, 4760, 4440, 10699, 10088, 9631, 6647, 4652, 7163]

layer_out_3   = [11713, 24883, 4452, 8359, 0, 7725, 1390, 59373, 434, 15295, 10062, 10341, 16659, 7033, 0, 721, 3746, 10309, 1262, 8421, 29678, 8608, 14999, 3596, 5280, 3096, 3662, 7401, 19083, 1845,  0, 11939, 6750, 1564, 8856, 12354, 11658, 10028, 3209, 12679, 7563, 1391, 31586, 9865, 13305, 0, 1027, 5093, 8933, 8450, 7432, 14485, 11200, 15172, 5297, 4085, 4668, 4338, 10243,  9838, 9062, 6358, 4815, 7258]

# nshift: 15, shift_32:15, shift_8:9
layer_out_3_8 = [22, 48, 8, 16, 0, 15, 2, 115, 0, 29, 19, 20, 32, 13, 0, 1, 7, 20, 2, 16, 57, 16, 29, 7, 10, 6, 7, 14, 37, 3, 0, 23, 13, 3, 17, 24, 22, 19, 6, 24, 14, 2, 61, 19, 25, 0, 2, 9, 17, 16, 14, 28, 21, 29, 10, 7, 9, 8, 20, 19, 17, 12, 9, 14]
```

- 第四层

```python
# state
# 浮点
mem_state_float = np.concatenate([layer_out_3_float, before_state_float], axis=0).reshape(7, -1).transpose()
# 定点
mem_state = np.concatenate([layer_out_3_8, before_state], axis=0).reshape(7, -1).transpose()

# att
# 浮点计算
weight_4_float = np.load("save/Variable_0_float.npy")
layer_out_4_float = np.sum(np.multiply(weight_4_float, mem_state_float), axis=1)
#量化
layer_out_4_q = (layer_out_4_float * 2**5).astype(np.int32)
#定点计算: Q7 * Q-2 = Q5
weight_4 = np.load("save/Variable_0.npy").astype(np.int32)
layer_out_4 = np.sum(np.multiply(weight_4, mem_state), axis=1)

# 8位缩放: Q5 >> 5 = Q0
n_shift = int(np.log2(max(abs(layer_out_4.min()), abs(layer_out_4.max()))))
shift_32 = 31 - n_shift - 1
shift_8 = 31 - 7 - shift_32

print("nshift: {}, shift_32:{}, shift_8:{}".format(n_shift, shift_32, shift_8))

layer_out_4_8 = layer_out_4 >> shift_8
```

```
layer_out_4_q = [-763, 1213, 955, 586, 0, 546, 192, -1248, -148, 1744, -1154, 1053, -1391, -325, 0, -417, -732, -1278, 458, -181, -2124, -1546, 3648, 254, 652, -295, 83, 896, -639, 413, 7, -819, 1012, 11, -1455, 1658, 521, -535, 180, 2408, 612, 287, 943, -1124, -1844, 0, -103, -363, -975, -1857, 739, -1998, -1718, -1932, 1045, 463, -724, 2, -524, 1996, -862, -921, -1237, 1765]

layer_out_4   = [-726, 1152, 872, 576, 0, 540, 114, -1150,    0, 1682, -1121, 1020, -1376, -299, 0, -246, -672, -1240, 330, -176, -2052, -1424, 3596, 259, 610, -276, 70, 826, -592, 291, 0, -782,  949, 15, -1377, 1584, 484, -513, 156, 2304, 532, 220, 976, -1102, -1725, 0,  -94, -297, -935, -1744, 630, -1960, -1596, -1827,  980, 406, -693, 0, -480, 1938, -782, -852, -1224, 1764]

# nshift: 11, shift_32:19, shift_8:5
layer_out_4_8 = [-23, 36, 27, 18, 0, 16, 3, -36, 0, 52, -36, 31, -43, -10, 0, -8, -21, -39, 10, -6, -65, -45, 112, 8, 19, -9, 2, 25, -19, 9, 0, -25, 29, 0, -44, 49, 15, -17, 4, 72, 16, 6, 30, -35, -54, 0, -3, -10, -30, -55, 19, -62, -50, -58, 30, 12, -22, 0, -15, 60, -25, -27, -39, 55]
```


- 第五层计算

```python
# 浮点计算
weight_5_float = np.load("save/Variable_1_0_float.npy")
bias_5_float = np.load("save/Variable_2_0_float.npy")
layer_out_5_float = np.matmul(weight_5_float, layer_out_4_float) + bias_5_float
#量化
layer_out_5_q = (layer_out_5_float * 2**8).astype(np.int32)
#定点计算: Q8 * Q0 + Q9>>1
weight_5 = np.load("save/Variable_1_0.npy").astype(np.int32)
bias_5 = np.load("save/Variable_2_0.npy").astype(np.int32)
layer_out_5 = np.matmul(weight_5, layer_out_4_8) + (bias_5>>1)

```

```
layer_out_5_q = [935, -3581, -3535, -6730, -490, -7645, -6615, -8837, -11087, -5339, -7885, -5405, -5471, 5007, -7456, -23218, -20523, -5920, 7145, -20958, -8647, -1106, -1473, -12129, -11195, -17731, -10745, -6270, -7077, -7545, -14470, 2043, -3939, -11837, -13675, 10570, -8765, -775, -395, -15696, -6836, 3099, -12731, 2977, -13915, -8774, -15699, 7615, -2753, -4710, 2720, -8937, -18809, -565, -3020, -6704, -7142, -202, -13242, -5356, -6178, -16005, -9689, 1241, -5612, 19827]

layer_out_5   = [835, -3604, -3502, -6082,   -7, -7654, -5876, -8870, -10512, -5330, -7854, -5075, -4740, 4933, -6651, -21533, -19921, -4585, 7346, -20642, -7900, -1507,  -889, -11608,  -9780, -16806, -10338, -6037, -5594, -7684, -15030, 2287, -2918, -11894, -13656, 10530, -8285, -299,    3, -16085, -5980, 3381, -11390, 3241, -12649, -7710, -15137, 8449, -2547, -4683, 3340, -9260, -19395, -626, -3019, -6433, -6503, -209, -12163, -4846, -5177, -15681, -9547, 1146, -5809, 19038]
```

- softmax

```python
#浮点计算: 减去最大值,防止溢出
out_exp_float = np.exp(layer_out_5_float - layer_out_5_float.max())

out_sum_float = np.sum(out_exp_float)
prob_float = out_exp_float / out_sum_float

prob_float_q = (prob_float * (2 ** 15)).astype(np.int32)


def iexp(x, Q):
    tmp = x / (2**Q)
    r = np.exp(tmp)
    if x<0:
        int_r = int(r * (2 ** (Q -1)))
    else:
        int_r = int(r * (2**Q))
    return int_r
# 定点计算: 减去最大值, 防止溢出
exp_int_func = np.frompyfunc(iexp, 2, 1)
out_exp = exp_int_func(layer_out_5 - layer_out_5.max(), 8)

out_exp_sum = np.sum(out_exp)

prob = ((out_exp << 15) / out_exp_sum).astype(np.int32)
```

```
prob_float_q = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32767]

prob         = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32768]
```